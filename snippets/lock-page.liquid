{% liquid
    assign customer_tag_shop = shop.metafields.custom.customer_discounts.value
    assign unlock_page = true

    if customer and customer_tag_shop.size > 0
        for tag in customer.tags
            assign found_tag = customer_tag_shop | where: 'customer_tag' , tag
            assign applies_to = found_tag[0].applies_to.value.products | where: 'id', product.id

            if applies_to.size > 0 and found_tag.size > 0
                assign unlock_page = true
                break
            endif
        endfor
    elsif customer_tag_shop.size > 0 and template.name == 'product'
        for item in customer_tag_shop
            assign applies_to = item.applies_to.value.products | where: 'id', product.id

            if item.customer_tag != blank and applies_to.size > 0 and applies_to[0].type == 'Wholesale'
                assign unlock_page = false
                break
            endif
        endfor
    elsif collection.metafields.custom.lock_collection == true
        assign unlock_page = false
    endif

    echo unlock_page
%}